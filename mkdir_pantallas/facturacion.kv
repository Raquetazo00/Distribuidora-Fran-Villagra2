#:import dp kivy.metrics.dp
#:import MDCard kivymd.uix.card.MDCard
#:import MDRaisedButton kivymd.uix.button.MDRaisedButton
#:import MDTextField kivymd.uix.textfield.MDTextField

<FacturaScreen>:

    canvas.before:
        Color:
            rgba: 0.96, 0.96, 0.98, 1
        Rectangle:
            pos: self.pos
            size: self.size

    MDBoxLayout:
        orientation: "vertical"
        spacing: dp(20)
        padding: dp(25)

        # =====================================================
        #   BOTÓN VOLVER (arriba a la derecha)
        # =====================================================
        MDBoxLayout:
            size_hint_y: None
            height: dp(40)

            Widget:

            MDRaisedButton:
                text: "< Volver"
                md_bg_color: 0.1, 0.2, 0.35, 1
                text_color: 1,1,1,1
                size_hint: None, None
                size: dp(120), dp(35)
                on_release: root.volver_menu()

        # =====================================================
        # TÍTULO
        # =====================================================
        MDLabel:
            text: "Facturación"
            halign: "center"
            font_style: "H4"
            size_hint_y: None
            height: dp(45)
            color: 0.15, 0.15, 0.15, 1

        # =====================================================
        # TIPO DE FACTURA
        # =====================================================
        MDCard:
            radius: 20
            elevation: 4
            padding: dp(20)
            md_bg_color: 1,1,1,1
            size_hint_y: None
            height: dp(80)

            MDBoxLayout:
                orientation: "horizontal"
                spacing: dp(15)

                MDLabel:
                    text: "Tipo de Factura:"
                    size_hint_x: None
                    width: dp(150)
                    bold: True
                    font_size: dp(18)
                    halign: "left"
                    valign: "middle"

                Spinner:
                    id: tipo_factura
                    text: "Factura A"
                    values: ["Factura A", "Factura B"]
                    size_hint_x: None
                    width: dp(180)
                    font_size: dp(17)

                Widget:

        # =====================================================
        # SECCIÓN DATOS DEL CLIENTE
        # =====================================================
        MDLabel:
            text: "Datos del Cliente"
            font_style: "H5"
            size_hint_y: None
            height: dp(40)
            color: 0.1, 0.1, 0.1, 1

        MDCard:
            radius: 20
            padding: dp(20)
            elevation: 3
            md_bg_color: 1, 1, 1, 1
            size_hint_y: None
            height: dp(220)

            MDBoxLayout:
                orientation: "vertical"
                spacing: dp(15)

                # --- Botones Clientes ---
                MDBoxLayout:
                    size_hint_y: None
                    height: dp(45)
                    spacing: dp(10)

                    MDRaisedButton:
                        text: "Clientes"
                        md_bg_color: 0.1, 0.3, 0.6, 1
                        text_color: 1,1,1,1
                        size_hint_x: None
                        width: dp(120)
                        on_release: root.abrir_gestion_clientes()

                    MDRaisedButton:
                        text: "Seleccionar Cliente"
                        md_bg_color: 0.15, 0.55, 0.85, 1
                        text_color: 1,1,1,1
                        size_hint_x: None
                        width: dp(180)
                        on_release: root.abrir_selector_cliente()

                    Widget:

                # --- Formulario en 2 columnas ---
                GridLayout:
                    cols: 2
                    spacing: dp(10)
                    row_force_default: True
                    row_default_height: dp(45)
                    size_hint_y: None
                    height: dp(110)

                    MDTextField:
                        id: cliente_nombre
                        hint_text: "Nombre"
                        mode: "rectangle"

                    MDTextField:
                        id: cliente_telefono
                        hint_text: "Teléfono"
                        mode: "rectangle"

                    MDTextField:
                        id: cliente_email
                        hint_text: "Email"
                        mode: "rectangle"

                    MDTextField:
                        id: cliente_ci
                        hint_text: "C.I. / RUT"
                        mode: "rectangle"

        # =====================================================
        # CONTENEDOR PRINCIPAL (Productos + Carrito)
        # =====================================================
        MDBoxLayout:
            orientation: "horizontal"
            spacing: dp(25)
            size_hint_y: 1

            # -----------------------------------------
            # IZQUIERDA – Agregar productos
            # -----------------------------------------
            MDCard:
                radius: 20
                elevation: 3
                padding: dp(20)
                md_bg_color: 1,1,1,1

                MDBoxLayout:
                    orientation: "vertical"
                    spacing: dp(15)

                    MDLabel:
                        text: "Agregar productos"
                        font_style: "H6"
                        size_hint_y: None
                        height: dp(35)

                    MDTextField:
                        id: buscar_producto
                        hint_text: "Buscar producto..."
                        mode: "rectangle"
                        size_hint_y: None
                        height: dp(45)
                        on_text: root.buscar_producto_factura(self.text)

                    ScrollView:
                        size_hint_y: 0.4
                        bar_width: dp(8)

                        MDBoxLayout:
                            id: resultados_busqueda
                            orientation: "vertical"
                            size_hint_y: None
                            height: self.minimum_height
                            spacing: dp(6)

                    MDBoxLayout:
                        size_hint_y: None
                        height: dp(45)
                        spacing: dp(10)

                        MDTextField:
                            id: cantidad_producto
                            hint_text: "1"
                            mode: "rectangle"
                            input_filter: "int"
                            size_hint_x: .3

                        MDRaisedButton:
                            text: "Agregar"
                            size_hint_x: .7
                            md_bg_color: 0.15, 0.45, 0.7, 1
                            text_color: 1,1,1,1
                            on_release: root._agregar_wrapper()

            # -----------------------------------------
            # DERECHA – Carrito de Compras
            # -----------------------------------------
            MDCard:
                radius: 20
                elevation: 3
                padding: dp(20)
                md_bg_color: 1,1,1,1

                MDBoxLayout:
                    orientation: "vertical"
                    spacing: dp(10)

                    MDLabel:
                        text: "Carrito de Compras"
                        font_style: "H6"
                        size_hint_y: None
                        height: dp(35)

                    ScrollView:
                        size_hint_y: 1
                        bar_width: dp(8)

                        GridLayout:
                            id: carrito_grid
                            cols: 5
                            spacing: dp(10)
                            size_hint_y: None
                            height: self.minimum_height

                    MDLabel:
                        text: "TOTAL: $" + str(root.total_carrito)
                        font_style: "H5"
                        size_hint_y: None
                        height: dp(45)
                        color: 0.1, 0.1, 0.1, 1

                    MDBoxLayout:
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(12)

                        MDRaisedButton:
                            text: "Vaciar Carrito"
                            md_bg_color: 0.8, 0.2, 0.2, 1
                            text_color: 1,1,1,1
                            on_release: root.limpiar_carrito()

                        MDRaisedButton:
                            text: "Generar Factura"
                            md_bg_color: 0.15, 0.6, 0.25, 1
                            text_color: 1,1,1,1
                            on_release: root._generar_wrapper()
